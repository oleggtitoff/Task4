#define _CRT_SECURE_NO_WARNINGS

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <math.h>

#define OUTPUT_FILE_NAME "Output.wav"
#define FILE_HEADER_SIZE 44
#define SIGNAL_TIME 1.5	//seconds		//TODO: from cmd
#define SAMPLE_RATE 48000
#define CHANNELS 2
#define BYTES_PER_SAMPLE 2
#define START_FREQUENCY 20.0			//TODO: from cmd
#define STOP_FREQUENCY 22000.0			//TODO: from cmd
#define AMPLITUDE 0.8					//TODO: from cmd
#define FILTER_COEFFICIENTS_NUM 128

#define PI 3.14159265358979323846
#define FLOAT_MAX 3.402823466e+38F

#define BITS_PER_SAMPLE ((BYTES_PER_SAMPLE) * 8)
#define SAMPLES_NUM	((uint32_t)round((SAMPLE_RATE) * (SIGNAL_TIME)))

typedef struct {
	uint8_t currNum;
	int16_t samples[FILTER_COEFFICIENTS_NUM];
} RingBuff;

typedef struct {
	uint8_t fileFormat[4];
	uint32_t fileSize;
	uint8_t fileTypeHeader[4];
	uint8_t formatChunkMarker[4];
	uint32_t formatDataLength;
	uint16_t formatType;
	uint16_t channels;
	uint32_t sampleRate;
	uint32_t byterate;
	uint16_t blockAlign;
	uint16_t bitsPerSample;
	uint8_t dataChunkHeader[4];
	uint32_t dataSize;
} WavHeader;

int16_t doubleToFixed15(double x);
int32_t doubleToFixed32(double x);
void coefsDoubleToFixed32(double *input, int32_t *output);
void ringInitialization(RingBuff *buff);

void initializeFileHeader(WavHeader *header);
FILE * openFile(char *fileName, _Bool mode);
void writeHeader(WavHeader *headerBuff, FILE *outputFilePtr);

void generateToneSignal(int16_t *buff);
void generateSweepSignal(int16_t *buff);
void generateNoiseSignal(int16_t *buff);

int16_t firFilter(RingBuff *ringBuff, int32_t *coefsBuff);
void filterData(int16_t *buff, RingBuff *ringBuff, int32_t *coefsBuff);

int getopt(int argc, char *const argv[], const char *optstring);	//TODO

int main(int argc, char *argv[])
{
	WavHeader header;
	initializeFileHeader(&header);
	FILE *outputFilePtr = openFile(OUTPUT_FILE_NAME, 1);
	writeHeader(&header, outputFilePtr);

	int16_t *buff = malloc(sizeof(int16_t) * SAMPLES_NUM * CHANNELS);
	double coefsDoubleBuff[FILTER_COEFFICIENTS_NUM] = {
		-0.000162164358122296535080070212231362348,
		0.001871990160621829881251731997338083602,
		0.000177421074278205637142491468694061041,
		-0.000799938339957202400667957142843533802,
		0.000029445930738341338089858467697013111,
		0.000975875559570133681644432677160239109,
		-0.000174332633474075845286810348966355377,
		-0.001142739689442697631482914744083245751,
		0.000370491577463436688212594649627362742,
		0.001301881690598231770816806118773456546,
		-0.000622077986506033506208801497905369615,
		-0.001441449932844418493210758569489371439,
		0.000932402583730824563272576721573159375,
		0.001550174587877081733289230669470271096,
		-0.001302822619389340953049982729794464831,
		-0.001613386681590385333950887769560722518,
		0.001732469863172050698885140462834897335,
		0.001616617300957494916813228513774447492,
		-0.00221862576667492894869071484720279841,
		-0.001543657072345475025215710829229465162,
		0.002754940419298467901149107817104777496,
		0.001378463028443757676377856569160940126,
		-0.003333276559124515384113784932651469717,
		-0.001103707153510167897347837850929863635,
		0.003941689681336679740297768148593604565,
		0.000703262526727135503512577940909977769,
		-0.004565291704341306600056782372121233493,
		-0.000160412088138313022045444711238815216,
		0.005184773540519031602424870897038999829,
		-0.000539621548383245391508622468279554596,
		-0.005778912866566685360703026219653111184,
		0.001411823120786187893416219196751626441,
		0.006322138141064522626200172794597165193,
		-0.00246974610702698545855460210418641509,
		-0.006786253611573941565970891076631232863,
		0.003728315587545509915412544899027125211,
		0.00713721779746414979050950222472238238,
		-0.005200340179343024282765384214144432917,
		-0.007338326806005588710812848063369528973,
		0.006901001742960421840578089103246384184,
		0.007346158056545955619687227056147094117,
		-0.00884755574351601785376697506535492721,
		-0.007111774028954947340919190423846885096,
		0.011067298609159212374741798612376442179,
		0.006570507333481337766678542777754046256,
		-0.013595462859419383747083820423995348392,
		-0.005644429523601306696034551890761576942,
		0.016492964039346743460034971917593793478,
		0.004223704726346500307188058798146812478,
		-0.019858876451125911932749090738070663065,
		-0.002145249494208243887238829472607903881,
		0.02386518959950843093986705412135052029,
		-0.000856104435109718980845272540136647876,
		-0.028832854859967373128970535844928235747,
		0.005258383178987129091819241466509993188,
		0.035404998106579571581775667254987638444,
		-0.012038069712799946003878304168210888747,
		-0.045046331468904660111363114083360414952,
		0.023589425202695950972708871518079831731,
		0.06186864353234792363034344475636316929,
		-0.047784444108668819306551256431703222916,
		-0.103231863934425432960395596637681592256,
		0.134497338921223313912278740644978825003,
		0.464599278002360449590923963114619255066,
		0.464599278002360449590923963114619255066,
		0.134497338921223313912278740644978825003,
		-0.103231863934425432960395596637681592256,
		-0.047784444108668819306551256431703222916,
		0.06186864353234792363034344475636316929,
		0.023589425202695950972708871518079831731,
		-0.045046331468904660111363114083360414952,
		-0.012038069712799946003878304168210888747,
		0.035404998106579571581775667254987638444,
		0.005258383178987129091819241466509993188,
		-0.028832854859967373128970535844928235747,
		-0.000856104435109718980845272540136647876,
		0.02386518959950843093986705412135052029,
		-0.002145249494208243887238829472607903881,
		-0.019858876451125911932749090738070663065,
		0.004223704726346500307188058798146812478,
		0.016492964039346743460034971917593793478,
		-0.005644429523601306696034551890761576942,
		-0.013595462859419383747083820423995348392,
		0.006570507333481337766678542777754046256,
		0.011067298609159212374741798612376442179,
		-0.007111774028954947340919190423846885096,
		-0.00884755574351601785376697506535492721,
		0.007346158056545955619687227056147094117,
		0.006901001742960421840578089103246384184,
		-0.007338326806005588710812848063369528973,
		-0.005200340179343024282765384214144432917,
		0.00713721779746414979050950222472238238,
		0.003728315587545509915412544899027125211,
		-0.006786253611573941565970891076631232863,
		-0.00246974610702698545855460210418641509,
		0.006322138141064522626200172794597165193,
		0.001411823120786187893416219196751626441,
		-0.005778912866566685360703026219653111184,
		-0.000539621548383245391508622468279554596,
		0.005184773540519031602424870897038999829,
		-0.000160412088138313022045444711238815216,
		-0.004565291704341306600056782372121233493,
		0.000703262526727135503512577940909977769,
		0.003941689681336679740297768148593604565,
		-0.001103707153510167897347837850929863635,
		-0.003333276559124515384113784932651469717,
		0.001378463028443757676377856569160940126,
		0.002754940419298467901149107817104777496,
		-0.001543657072345475025215710829229465162,
		-0.00221862576667492894869071484720279841,
		0.001616617300957494916813228513774447492,
		0.001732469863172050698885140462834897335,
		-0.001613386681590385333950887769560722518,
		-0.001302822619389340953049982729794464831,
		0.001550174587877081733289230669470271096,
		0.000932402583730824563272576721573159375,
		-0.001441449932844418493210758569489371439,
		-0.000622077986506033506208801497905369615,
		0.001301881690598231770816806118773456546,
		0.000370491577463436688212594649627362742,
		-0.001142739689442697631482914744083245751,
		-0.000174332633474075845286810348966355377,
		0.000975875559570133681644432677160239109,
		0.000029445930738341338089858467697013111,
		-0.000799938339957202400667957142843533802,
		0.000177421074278205637142491468694061041,
		0.001871990160621829881251731997338083602,
		-0.000162164358122296535080070212231362348
	};
	int32_t coefsBuff[FILTER_COEFFICIENTS_NUM];
	RingBuff samplesBuff;

	coefsDoubleToFixed32(coefsDoubleBuff, coefsBuff);
	ringInitialization(&samplesBuff);

	//generateNoiseSignal(buff);
	//generateToneSignal(buff);
	generateSweepSignal(buff);
	filterData(buff, &samplesBuff, coefsBuff);
	fwrite(buff, BYTES_PER_SAMPLE, SAMPLES_NUM * CHANNELS, outputFilePtr);
	fclose(outputFilePtr);

	system("pause");
	return 0;
}

int16_t doubleToFixed15(double x)
{
	if (x >= 1)
	{
		return INT16_MAX;
	}
	else if (x < -1)
	{
		return INT16_MIN;
	}

	return (int16_t)(x * (double)(1LL << 15));
}

int32_t doubleToFixed32(double x)
{
	if (x >= 1)
	{
		return INT32_MAX;
	}
	else if (x < -1)
	{
		return INT32_MIN;
	}

	return (int32_t)(x * (double)(1LL << 31));
}

void coefsDoubleToFixed32(double *input, int32_t *output)
{
	int16_t i;

	for (i = 0; i < FILTER_COEFFICIENTS_NUM; i++)
	{
		output[i] = doubleToFixed32(input[i]);
	}
}

void ringInitialization(RingBuff *buff)
{
	int i;

	for (i = 0; i < FILTER_COEFFICIENTS_NUM; i++)
	{
		buff->samples[i] = 0;
	}

	buff->currNum = 0;
}

void initializeFileHeader(WavHeader *header)
{
	*(header->fileFormat) = 'R';
	*(header->fileFormat + 1) = 'I';
	*(header->fileFormat + 2) = 'F';
	*(header->fileFormat + 3) = 'F';

	*(header->fileTypeHeader) = 'W';
	*(header->fileTypeHeader + 1) = 'A';
	*(header->fileTypeHeader + 2) = 'V';
	*(header->fileTypeHeader + 3) = 'E';

	*(header->formatChunkMarker) = 'f';
	*(header->formatChunkMarker + 1) = 'm';
	*(header->formatChunkMarker + 2) = 't';
	*(header->formatChunkMarker + 3) = ' ';

	*(header->dataChunkHeader) = 'd';
	*(header->dataChunkHeader + 1) = 'a';
	*(header->dataChunkHeader + 2) = 't';
	*(header->dataChunkHeader + 3) = 'a';

	header->formatDataLength = 16;
	header->formatType = 1;
	header->channels = CHANNELS;
	header->sampleRate = SAMPLE_RATE;
	header->bitsPerSample = 16;
	header->byterate = (SAMPLE_RATE * BITS_PER_SAMPLE * CHANNELS) / 8;
	header->blockAlign = (BITS_PER_SAMPLE * CHANNELS) / 8;
	header->dataSize = SAMPLES_NUM * header->blockAlign;
	header->fileSize = header->dataSize  + FILE_HEADER_SIZE;
}

FILE * openFile(char *fileName, _Bool mode)		//if 0 - read, if 1 - write
{
	FILE *filePtr;

	if (mode == 0)
	{
		if ((filePtr = fopen(fileName, "rb")) == NULL)
		{
			printf("Error opening input file\n");
			system("pause");
			exit(0);
		}
	}
	else
	{
		if ((filePtr = fopen(fileName, "wb")) == NULL)
		{
			printf("Error opening output file\n");
			system("pause");
			exit(0);
		}
	}

	return filePtr;
}

void writeHeader(WavHeader *headerBuff, FILE *outputFilePtr)
{
	if (fwrite(headerBuff, FILE_HEADER_SIZE, 1, outputFilePtr) != 1)
	{
		printf("Error writing output file (header)\n");
		system("pause");
		exit(0);
	}
}

void generateToneSignal(int16_t *buff)
{
	uint32_t i;
	uint32_t timeCounter = 0;

	for (i = 0; i < SAMPLES_NUM * CHANNELS; i += CHANNELS)
	{
		buff[i] = doubleToFixed15(AMPLITUDE * sin(2 * PI * START_FREQUENCY * (double)timeCounter / (SAMPLE_RATE)));
		buff[i + 1] = buff[i];
		timeCounter++;
	}
}

void generateSweepSignal(int16_t *buff)
{
	uint32_t i;
	uint32_t timeCounter = 0;
	double Omega1 = 2 * PI * START_FREQUENCY;
	double Omega2 = 2 * PI * STOP_FREQUENCY;
	double log1 = log(Omega2 / Omega1);
	double t1;
	double exp1;

	for (i = 0; i < SAMPLES_NUM * CHANNELS; i += CHANNELS)
	{
		t1 = (double)timeCounter / SAMPLES_NUM;
		exp1 = exp(t1 * log1) - 1;
		buff[i] = doubleToFixed15(AMPLITUDE * sin(Omega1 * SAMPLES_NUM * exp1 / (SAMPLE_RATE * log1)));
		buff[i + 1] = buff[i];
		timeCounter++;
	}
}

void generateNoiseSignal(int16_t *buff)
{

	uint32_t i;

	for (i = 0; i < SAMPLES_NUM * CHANNELS; i += CHANNELS)
	{
		buff[i] = doubleToFixed15(AMPLITUDE * ((double)rand() / RAND_MAX * 2.0 - 1.0));
		buff[i + 1] = buff[i];
	}
}

int16_t firFilter(RingBuff *ringBuff, int32_t *coefsBuff)
{
	uint8_t index;
	uint16_t i;
	int16_t sample;
	int64_t accum = 0;

	for (i = 0; i < FILTER_COEFFICIENTS_NUM; i++)
	{
		index = ((ringBuff->currNum - i) & (FILTER_COEFFICIENTS_NUM - 1));
		sample = ringBuff->samples[index];
		accum += (int64_t)sample * coefsBuff[i];
	}

	ringBuff->currNum = (ringBuff->currNum + 1) & (FILTER_COEFFICIENTS_NUM - 1);

	return (int16_t)((accum + (1LL << 30)) >> 31);
}

void filterData(int16_t *buff, RingBuff *ringBuff, int32_t *coefsBuff)
{
	uint32_t i;

	for (i = 0; i < SAMPLES_NUM * CHANNELS; i += CHANNELS)
	{
		ringBuff->samples[ringBuff->currNum] = buff[i];
		buff[i] = firFilter(ringBuff, coefsBuff);
	}
}
